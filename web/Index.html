<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Tercio Labs – Multi-Motor & IMU Control</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b0e;
      --fg: #e5e7eb;
      --card: #121217;
      --card2: #0f1117;
      --border: #262632;
      --muted: #9ca3af;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;
      --purple: #8b5cf6;
      --switch-bg: #1f2937;
      --switch-on: #10b981;
      --switch-knob: #fff;
      --field-bg: #1b1f2a;
      --field-border: #2e3347;
      --btn-secondary-bg: #1f2937;
      --btn-secondary-fg: #e5e7eb;

      --row-bg: #0e111a;
      --log-bg: #000;

      --badge-bg: rgba(255, 255, 255, 0.06);
      --badge-fg: #e5e7eb;
    }

    /* THEME – DARK */
    :root[data-theme="dark"] {
      --bg: #0b0b0e;
      --fg: #e5e7eb;
      --card: #121217;
      --card2: #0f1117;
      --border: #262632;
      --muted: #9ca3af;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;
      --field-bg: #1b1f2a;
      --field-border: #2e3347;
      --btn-secondary-bg: #1f2937;
      --btn-secondary-fg: #e5e7eb;
      --row-bg: #0e111a;
      --log-bg: #000;
      --badge-bg: rgba(255, 255, 255, 0.06);
      --badge-fg: #e5e7eb;
      --switch-bg: #1f2937;
      --switch-on: #10b981;
      --switch-knob: #fff;
    }

    /* THEME – LIGHT */
    :root[data-theme="light"] {
      --bg: #f7f8fc;
      --fg: #0f172a;
      --card: #ffffff;
      --card2: #f5f7fb;
      --border: #d7deea;
      --muted: #64748b;
      --accent: #059669;
      --accent-2: #2563eb;
      --warn: #d97706;
      --danger: #dc2626;
      --field-bg: #f3f6fb;
      --field-border: #d7deea;
      --btn-secondary-bg: #eef2f7;
      --btn-secondary-fg: #0f172a;
      --row-bg: #ffffff;
      --log-bg: #111;
      --badge-bg: rgba(15, 23, 42, 0.06);
      --badge-fg: #0f172a;
      --switch-bg: #e5e7eb;
      --switch-on: #059669;
      --switch-knob: #fff;
    }

    @media (prefers-color-scheme: light) {
      :root[data-theme="auto"] {
        color-scheme: light
      }
    }

    @media (prefers-color-scheme: dark) {
      :root[data-theme="auto"] {
        color-scheme: dark
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      max-width: 100%;
      overflow-x: hidden
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 24px
    }

    h2 {
      margin: 0 0 8px 0
    }

    small {
      color: var(--muted)
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px
    }

    @media (max-width:1024px) {
      .app {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn {
      background: var(--accent);
      border: 0;
      color: #08221a;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600
    }

    .btn.secondary {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-fg)
    }

    .btn.info {
      background: var(--accent-2);
      color: #081422
    }

    .btn.warn {
      background: var(--warn);
      color: #1b1405
    }

    .btn.danger {
      background: var(--danger);
      color: #2b0b0b
    }

    .btn.magic {
      background: var(--purple);
      color: #fff;
    }

    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed
    }

    input,
    select,
    textarea {
      background: var(--field-bg);
      border: 1px solid var(--field-border);
      color: var(--fg);
      border-radius: 10px;
      padding: 12px 14px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Consolas, Monaco, monospace
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px
    }

    @media (max-width:1024px) {
      .split {
        grid-template-columns: 1fr
      }
    }

    .pill {
      background: var(--badge-bg);
      color: var(--badge-fg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      display: inline-flex;
      gap: 8px;
      align-items: center
    }

    .hint {
      color: var(--muted);
      font-size: 12px
    }

    .warnbar {
      background: #2a1111;
      border: 1px solid #6b1d1d;
      color: #ffd2d2;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .warnbar.stall {
      background: #451a1a;
      border-color: #ef4444;
      color: #fca5a5;
      font-weight: bold;
    }

    .hidden {
      display: none !important;
    }


    /* Devices header layout */
    .dev-header2 {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 12px;
    }

    .dev-header2 .title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dev-header2 .title h2 {
      margin: 0
    }

    .dev-header2 .title .sub {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.2;
    }

    .dev-header2 .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .dev-header2 .controls select {
      padding: 8px 12px;
      border-radius: 10px;
    }

    @media (max-width:700px) {
      .dev-header2 {
        flex-direction: column;
        align-items: stretch;
      }

      .dev-header2 .controls {
        flex-wrap: wrap;
      }
    }

    .search {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .dev-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 60vh;
      overflow: auto
    }

    .dev-item {
      border: 1px solid var(--border);
      background: var(--row-bg);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      cursor: pointer
    }

    .dev-item.active {
      outline: 2px solid var(--accent)
    }

    .dev-item.stalled {
      outline: 2px solid var(--danger)
    }

    .dev-item:focus {
      outline: 2px solid var(--accent-2)
    }

    .dev-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    .tag {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--badge-bg);
      color: var(--badge-fg)
    }

    .tag.warn {
      border-color: #6b1d1d;
      background: #2a1111;
      color: #ffd2d2
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    #log {
      background: var(--log-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      height: 36vh;
      overflow: auto;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      cursor: pointer
    }

    .toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none
    }

    .switch {
      width: 46px;
      height: 26px;
      background: var(--switch-bg);
      border: 1px solid var(--field-border);
      border-radius: 999px;
      position: relative;
      transition: .2s
    }

    .knob {
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 2px;
      transform: translateY(-50%);
      transition: left .2s
    }

    .toggle input:checked+.switch {
      background: var(--switch-on);
      border-color: transparent
    }

    .toggle input:checked+.switch .knob {
      left: 22px
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px
    }

    td,
    th {
      font-size: 13px;
      text-align: left;
      padding: 8px 10px
    }

    tr {
      background: var(--row-bg);
      border: 1px solid var(--border)
    }

    tr td:first-child,
    tr th:first-child {
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px
    }

    tr td:last-child,
    tr th:last-child {
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px
    }

    label:not(.toggle) {
      display: block !important;
      margin: 0 0 16px !important
    }

    label:not(.toggle)>input,
    label:not(.toggle)>select,
    label:not(.toggle)>textarea {
      display: block;
      width: 100%;
      margin-top: 12px !important
    }

    .label-inline {
      display: inline
    }

    .brand-header {
      text-align: center;
      padding: 16px 0 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: 0 0 20px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .brand-header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--fg);
    }

    .brand-header .brand-name {
      background: linear-gradient(90deg, #60a5fa, #93c5fd);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      filter: drop-shadow(0 0 2px rgba(96, 165, 250, 0.3));
    }

    /* --- IMU 3D Visualization --- */
    .imu-scene {
      width: 200px;
      height: 160px;
      perspective: 800px;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .cube {
      width: 0;
      height: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      transform-style: preserve-3d;
    }

    .cube-face {
      position: absolute;
      box-sizing: border-box;
      background: #1f2937;
      border: 1px solid #4b5563;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 10px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    /* Top & Bottom: 120x120 */
    .face-top,
    .face-bottom {
      width: 120px;
      height: 120px;
      margin: -60px 0 0 -60px;
      /* Center it */
    }

    /* Sides: 120x20 */
    .face-front,
    .face-back,
    .face-left,
    .face-right {
      width: 120px;
      height: 20px;
      margin: -10px 0 0 -60px;
      /* Center it */
    }

    /* TRANSFORMS */
    .face-top {
      transform: rotateX(90deg) translateZ(10px);
      background: #111827;
      border: 1px solid var(--accent);
    }

    .face-bottom {
      transform: rotateX(-90deg) translateZ(10px);
      background: #000;
    }

    .face-front {
      transform: translateZ(60px);
      background: #374151;
    }

    .face-back {
      transform: rotateY(180deg) translateZ(60px);
      background: #374151;
    }

    .face-right {
      transform: rotateY(90deg) translateZ(60px);
      background: #374151;
    }

    .face-left {
      transform: rotateY(-90deg) translateZ(60px);
      background: #374151;
    }

    /* Visual Arrow on Top */
    .face-top::after {
      content: "▲";
      font-size: 40px;
      color: var(--accent);
      opacity: 0.8;
    }

    /* --- AXIS GIZMO --- */
    .axis {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
      pointer-events: none;
    }

    /* X Axis - Red - Right */
    .axis-x {
      width: 150px;
      height: 2px;
      background: #ef4444;
      transform: rotateY(0deg);
      /* Points Right */
    }

    .axis-x::after {
      content: "X";
      color: #ef4444;
      position: absolute;
      right: -15px;
      top: -7px;
      font-weight: bold;
      font-size: 12px;
    }

    /* Y Axis - Green - Forward (into screen normally, but 3D space) */
    .axis-y {
      width: 150px;
      height: 2px;
      background: #10b981;
      transform: rotateY(-90deg);
      /* Points Forward/Back */
    }

    .axis-y::after {
      content: "Y";
      color: #10b981;
      position: absolute;
      right: -15px;
      top: -7px;
      font-weight: bold;
      font-size: 12px;
    }

    /* Z Axis - Blue - Up */
    .axis-z {
      width: 100px;
      height: 2px;
      background: #3b82f6;
      transform: rotateZ(-90deg);
      /* Points Up */
    }

    .axis-z::after {
      content: "Z";
      color: #3b82f6;
      position: absolute;
      right: -15px;
      top: -7px;
      font-weight: bold;
      font-size: 12px;
    }

    .imu-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      text-align: center;
      margin-top: 20px;
    }

    .imu-stat-box {
      background: var(--badge-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
    }

    .imu-stat-box div:first-child {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .imu-stat-box div:last-child {
      font-family: monospace;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <header class="brand-header">
    <h1>Tercio Labs <span>– Web Control UI</span></h1>
  </header>
  <div class="app">
    <div class="card">
      <div class="dev-header2">
        <div class="title">
          <h2>Devices</h2>
          <span class="sub">Auto-discovered from telemetry</span>
        </div>
        <div class="controls">
          <button id="btnConnect" class="btn">Connect</button>
          <select id="selTheme" title="Theme">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>

      <div class="search"> <input id="devSearch" placeholder="Filter by ID/status…" class="mono" style="flex:1">
        <button id="btnRefreshDevices" class="btn secondary">Refresh Devices</button> <button id="btnExport"
          class="btn secondary">Export CSV</button>
      </div>
      <div id="devList" class="dev-list" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="section-title">
        <div class="row">
          <h2 style="margin:0">Control</h2>
          <div id="status" class="pill"><small>Idle</small></div>
        </div>
        <div class="row">
          <div class="pill"><b>Active:</b> <span id="activeId" class="mono">—</span></div>
          <div id="imuTag" class="pill hidden" style="background: var(--purple); color: #fff;">IMU</div>
          <div id="motorUnitsTag" class="pill"><b>Units:</b> <span id="activeUnits" class="mono">rad</span></div>
        </div>
      </div>

      <div id="stallWarn" class="warnbar stall hidden">
        <span>⚠ <b>MOTOR STALLED!</b> Send a new target angle or use Auto-Tune to recover.</span>
      </div>
      <div id="calibWarn" class="warnbar hidden"><b>⚠ Not calibrated.</b> Run <i>Do Calibrate</i> on this device.
      </div>

      <div class="split" style="margin-top:10px">

        <div class="card">

          <div id="imuControls" class="hidden">
            <div class="section-title">
              <h3 style="margin:0;font-size:16px">IMU Orientation</h3>
              <button id="btnImuZero" class="btn info" style="padding: 4px 8px; font-size:12px;">Zero
                Orientation</button>
            </div>
            <div class="imu-scene">
              <div class="cube" id="imuCube">
                <div class="cube-face face-front"></div>
                <div class="cube-face face-back"></div>
                <div class="cube-face face-right"></div>
                <div class="cube-face face-left"></div>
                <div class="cube-face face-top"></div>
                <div class="cube-face face-bottom"></div>
                <div class="axis axis-x"></div>
                <div class="axis axis-y"></div>
                <div class="axis axis-z"></div>
              </div>
            </div>
            <div class="imu-stat-grid">
              <div class="imu-stat-box">
                <div>Roll</div>
                <div id="valRoll">0.00</div>
              </div>
              <div class="imu-stat-box">
                <div>Pitch</div>
                <div id="valPitch">0.00</div>
              </div>
              <div class="imu-stat-box">
                <div>Yaw</div>
                <div id="valYaw">0.00</div>
              </div>
              <div class="imu-stat-box">
                <div>Acc X</div>
                <div id="valAx">0.00</div>
              </div>
              <div class="imu-stat-box">
                <div>Acc Y</div>
                <div id="valAy">0.00</div>
              </div>
              <div class="imu-stat-box">
                <div>Acc Z</div>
                <div id="valAz">0.00</div>
              </div>
            </div>
          </div>

          <div id="motorControls">
            <div class="section-title">
              <h3 style="margin:0;font-size:16px">Quick Target</h3>
              <div class="pill"><b>Preview:</b> <span id="preview" class="mono">—</span></div>
            </div>
            <div class="grid">
              <label>
                <span class="label-inline">Target (<span id="targetUnits">rad</span>)</span>
                <input type="number" id="inTarget" step="0.001" value="0.50">
              </label>
              <label>Speed limit (rps)<input type="number" id="inRps" step="0.01" value="25.0"></label>
              <label>Accel limit (rps²)<input type="number" id="inRps2" step="0.1" value="150.0"></label>
              <label>Current (mA)<input type="number" id="inmA" step="1" value="1200"></label>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <button id="btnSendTarget" class="btn info gated">Send Target</button>
              <button id="btnSendLimits" class="btn secondary gated">Send Limits</button>
              <button id="btnSetCurrent" class="btn secondary gated">Set Current</button>
              <button id="btnCal" class="btn warn gated">Do Calibrate</button>
              <label class="toggle gated"><input id="tglEnable" type="checkbox"><span class="switch"><span
                    class="knob"></span></span><span>Enable Motor</span></label>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <button id="btn0" class="btn secondary gated">0</button>
              <button id="btn90" class="btn secondary gated">90°/π/2</button>
              <button id="btn180" class="btn secondary gated">180°/π</button>
            </div>

            <div class="section-title"
              style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px">
              <h3 style="margin:0;font-size:16px">Auto Tuning</h3>
              <div class="pill"><small>Finds Max Speed</small></div>
            </div>
            <div class="grid">
              <label>Min Angle (deg)<input type="number" id="inTuneMin" value="-500"></label>
              <label>Max Angle (deg)<input type="number" id="inTuneMax" value="500"></label>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <button id="btnAutoTune" class="btn magic gated">Start Auto-Tune</button>
            </div>

            <div class="hint" style="margin-top:10px">Frames: <span class="mono">ID_LO ID_H CMD LEN
                PAYLOAD…</span></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h3 style="margin:0;font-size:16px">Device Setup</h3>
          </div>
          <div class="grid">
            <label>Change ID<input id="newId" type="number" min="0" max="2047" value="2"></label>
            <div class="motor-specific"><label>Microsteps<input id="ms" type="number" min="1" value="16"></label></div>
            <div class="motor-specific"><label>Steps/Rev<input id="spr" type="number" min="1" value="200"></label></div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="btnApplyID" class="btn danger gated">Set ID</button>
            <button id="btnApplyStepper" class="btn secondary gated motor-specific">Apply Stepper Params</button>
          </div>

          <div class="section-title motor-specific" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">Modes & Flags</h3>
          </div>
          <div class="toolbar motor-specific" style="flex-wrap:wrap">
            <label class="toggle gated"><input id="tglUnitsDeg" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Use Degrees</span></label>
            <label class="toggle gated"><input id="tglStealth" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>StealthChop</span></label>
            <label class="toggle gated"><input id="tglExtEnc" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>External Encoder</span></label>
            <label class="toggle gated"><input id="tglExtMode" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>External Mode</span></label>
            <label class="toggle gated"><input id="tglEndstop" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Endstop</span></label>
            <label class="toggle gated"><input id="tglEncInvert" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Encoder Invert</span></label>
            <label class="toggle gated"><input id="tglDirInvert" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Direction Invert</span></label>
            <label class="toggle gated"><input id="tglExtSPI" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>External SPI</span></label>
          </div>

          <div class="section-title motor-specific" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">PID</h3>
          </div>
          <div class="grid motor-specific">
            <label>Kp<input id="pidKp" type="number" step="0.001" value="3.0"></label>
            <label>Ki<input id="pidKi" type="number" step="0.001" value="0.0"></label>
            <label>Kd<input id="pidKd" type="number" step="0.001" value="0.0"></label>
          </div>
          <div class="toolbar motor-specific" style="margin-top:8px">
            <button id="btnApplyPID" class="btn secondary gated">Apply PID</button>
          </div>

          <div class="section-title motor-specific" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">Homing</h3>
          </div>
          <div class="grid motor-specific">
            <label>Offset<input id="homeOffset" type="number" step="0.001" value="0.0"></label>
            <label>Speed (rps)<input id="homeSpeed" type="number" step="0.01" value="15.0"></label>
          </div>
          <div class="toolbar motor-specific" style="flex-wrap:wrap">
            <label class="toggle gated"><input id="homeUseMin" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Use MIN trigger</span></label>
            <label class="toggle gated"><input id="homeActiveLow" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Active Low</span></label>
            <label class="toggle gated"><input id="homeDirPlus" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Direction (+)</span></label>
            <button id="btnDoHome" class="btn warn gated">Do Homing</button>
          </div>

          <div class="section-title" style="margin-top:14px">
            <h3 style="margin:0;font-size:16px">Bulk ID Tools</h3>
          </div>
          <div class="row">
            <label>Start ID <input id="bulkStart" type="number" min="0" max="2047" value="1"
                style="width:110px"></label>
            <button id="btnSequential" class="btn warn">Assign Sequential IDs</button>
            <button id="btnRefreshList" class="btn secondary">Refresh List</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title">
          <h3 style="margin:0;font-size:16px">Live Telemetry</h3>
          <div class="row">
            <div class="pill"><b>Speed:</b> <span id="tlmSpeed" class="mono">—</span></div>
            <div class="pill"><b>Angle:</b> <span id="tlmAngle" class="mono">—</span></div>
            <div class="pill"><b>Temp:</b> <span id="tlmTemp" class="mono">—</span></div>
            <div class="pill"><b>Stalled:</b> <span id="tlmStalled" class="mono">—</span></div>
            <div class="pill"><b>Tune:</b> <span id="tlmTune" class="mono">—</span></div>
            <div class="pill"><b>Min:</b> <span id="tlmMin" class="mono">—</span></div>
            <div class="pill"><b>Max:</b> <span id="tlmMax" class="mono">—</span></div>
            <div class="pill"><b>Cal:</b> <span id="tlmCal" class="mono">—</span></div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Units</th>
              <th>Speed (Roll)</th>
              <th>Angle (Pitch)</th>
              <th>Temp (Yaw)</th>
              <th>Stalled</th>
              <th>Tune</th>
              <th>Min</th>
              <th>Max</th>
              <th>Cal</th>
              <th>Last seen</th>
            </tr>
          </thead>
          <tbody id="tblBodies"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title">
          <h3 style="margin:0;font-size:16px">I/O Log</h3>
          <div class="toolbar">
            <button id="btnClear" class="btn secondary">Clear</button>
            <button id="btnSave" class="btn secondary">Save</button>
          </div>
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const $ = id => document.getElementById(id);
      const clamp11 = n => Math.max(0, Math.min(0x7FF, n | 0));
      const hex2 = b => b.toString(16).toUpperCase().padStart(2, '0');
      const bytesHex = u8 => Array.from(u8).map(hex2).join(' ');
      const u8 = v => new Uint8Array([v & 0xFF]);
      const u16le = v => new Uint8Array([v & 0xFF, (v >> 8) & 0xFF]);
      const f32le = f => { const b = new ArrayBuffer(4); new DataView(b).setFloat32(0, Number(f) || 0, true); return new Uint8Array(b); };

      const CMD = {
        TARGET_ANGLE: 0x01, SET_CURRENT_MA: 0x02, SET_SPEED_LIMIT: 0x03, SET_PID: 0x04, SET_ID: 0x05,
        SET_MICROSTEPS: 0x06, SET_STEALTHCHOP: 0x07, SET_EXT_MODE: 0x08, SET_UNITS: 0x09, SET_ENC_INVERT: 0x0A,
        SET_ENABLED: 0x0B, SET_STEPS_PER_REV: 0x0C, DO_CALIBRATE: 0x0D, DO_HOMING: 0x0E, SET_ENDSTOP: 0x0F,
        SET_EXT_ENCODER: 0x10, SET_ACCEL_LIMIT: 0x11, SET_DIR_INVERT: 0x12, SET_EXT_SPI: 0x13,
        DO_AUTO_TUNE: 0x14,
        TELEMETRY: 0x01,
        IMU_TELEMETRY: 0x02,
        IMU_SETID: 0xA1,
        RESET_ORIENT: 0xA2
      };

      const TUNE_STATES = ['Idle', 'Prep', 'Fwd', 'Bwd', 'Inc', 'Done'];
      const header = (id, cmd, len) => new Uint8Array([id & 0xFF, (id >> 8) & 0xFF, cmd & 0xFF, len & 0xFF]);

      const frame = {
        target: (id, val) => { const p = f32le(val), h = header(id, CMD.TARGET_ANGLE, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        speed: (id, rps) => { const p = f32le(rps), h = header(id, CMD.SET_SPEED_LIMIT, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        accel: (id, a) => { const p = f32le(a), h = header(id, CMD.SET_ACCEL_LIMIT, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        current: (id, ma) => { const p = u16le(ma), h = header(id, CMD.SET_CURRENT_MA, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        
        // UPDATED ID LOGIC: Handles IMU (3-byte) vs Motor (2-byte)
        setId: (id, nid, isImu = false) => {
          if (isImu) {
             // IMU Protocol: Bridge inserts CMD (0xA1) at byte 0 automatically.
             // We only send [ID_LO, ID_HI] in the payload.
             const p = new Uint8Array(2); // Length 2
             const safe = clamp11(nid);
             p[0] = safe & 0xFF;        
             p[1] = (safe >> 8) & 0xFF;
             
             // The 0xA1 in the header becomes data[0] on the wire
             const h = header(id, CMD.IMU_SETID, p.length);
             const o = new Uint8Array(h.length + p.length);
             o.set(h, 0); o.set(p, h.length); 
             return o;
          } else {
             // Motor Protocol: [ID_LO, ID_HI]
             const p = u16le(clamp11(nid));
             const h = header(id, CMD.SET_ID, p.length);
             const o = new Uint8Array(h.length + p.length);
             o.set(h, 0); o.set(p, h.length);
             return o;
          }
        },

        microsteps: (id, n) => { const p = u16le(n), h = header(id, CMD.SET_MICROSTEPS, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        stepsPerRev: (id, n) => { const p = u16le(n), h = header(id, CMD.SET_STEPS_PER_REV, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        bool1: (id, cmd, on) => { const p = u8(on ? 1 : 0), h = header(id, cmd, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        pid: (id, kp, ki, kd) => { const p = new Uint8Array(12); p.set(f32le(kp), 0); p.set(f32le(ki), 4); p.set(f32le(kd), 8); const h = header(id, CMD.SET_PID, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        calibrate: (id) => header(id, CMD.DO_CALIBRATE, 0),
        homing: (id, { useMINTrigger, offset, activeLow, speed, direction }) => {
          const p = new Uint8Array(11);
          p[0] = useMINTrigger ? 1 : 0; p.set(f32le(offset), 1); p[5] = activeLow ? 1 : 0; p.set(f32le(speed), 6); p[10] = direction ? 1 : 0;
          const h = header(id, CMD.DO_HOMING, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o;
        },
        autoTune: (id, min, max) => {
          const p = new Uint8Array(8); p.set(f32le(min), 0); p.set(f32le(max), 4);
          const h = header(id, CMD.DO_AUTO_TUNE, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o;
        },
        resetOrient: (id) => header(id, CMD.RESET_ORIENT, 0)
      };

      // THEME – global
      const selTheme = $('selTheme');
      const THEME_KEY = 'tercio_theme_global';
      const applyTheme = t => document.documentElement.setAttribute('data-theme', t || 'auto');
      const saveTheme = t => { try { localStorage.setItem(THEME_KEY, t) } catch { } };
      const loadTheme = () => { try { return localStorage.getItem(THEME_KEY) || 'auto' } catch { return 'auto' } };
      selTheme.value = loadTheme(); applyTheme(selTheme.value);
      selTheme.addEventListener('change', () => { const t = selTheme.value; applyTheme(t); saveTheme(t); });

      // UI refs
      const devListEl = $('devList'), devSearch = $('devSearch');
      const statusEl = $('status'), previewEl = $('preview');
      const activeIdEl = $('activeId'), activeUnitsEl = $('activeUnits'), targetUnitsEl = $('targetUnits');
      const motorUnitsTag = $('motorUnitsTag'), imuTag = $('imuTag');
      const motorControls = $('motorControls'), imuControls = $('imuControls'), imuCube = $('imuCube');

      const inTarget = $('inTarget'), inRps = $('inRps'), inRps2 = $('inRps2'), inmA = $('inmA');
      const inTuneMin = $('inTuneMin'), inTuneMax = $('inTuneMax');
      const tglEnable = $('tglEnable');
      const newIdEl = $('newId'), msEl = $('ms'), sprEl = $('spr');
      const tglUnitsDeg = $('tglUnitsDeg'), tglStealth = $('tglStealth'), tglExtEnc = $('tglExtEnc'), tglExtMode = $('tglExtMode'), tglEndstop = $('tglEndstop'), tglEncInvert = $('tglEncInvert'), tglDirInvert = $('tglDirInvert'), tglExtSPI = $('tglExtSPI');
      const pidKp = $('pidKp'), pidKi = $('pidKi'), pidKd = $('pidKd');
      const homeOffset = $('homeOffset'), homeSpeed = $('homeSpeed'), homeUseMin = $('homeUseMin'), homeActiveLow = $('homeActiveLow'), homeDirPlus = $('homeDirPlus');
      const tlmSpeed = $('tlmSpeed'), tlmAngle = $('tlmAngle'), tlmTemp = $('tlmTemp'), tlmMin = $('tlmMin'), tlmMax = $('tlmMax'), tlmCal = $('tlmCal'), tlmStalled = $('tlmStalled'), tlmTune = $('tlmTune');
      const tblBodies = $('tblBodies');
      const logEl = $('log');
      const stallWarn = $('stallWarn'), calibWarn = $('calibWarn');

      // IMU Vals
      const valRoll = $('valRoll'), valPitch = $('valPitch'), valYaw = $('valYaw');
      const valAx = $('valAx'), valAy = $('valAy'), valAz = $('valAz');

      const setStatus = txt => statusEl.innerHTML = `<small>${txt}</small>`;
      const logLine = (p, buf, color) => {
        const time = new Date().toLocaleTimeString();
        const text = (buf instanceof Uint8Array) ? bytesHex(buf) : String(buf);
        const div = document.createElement('div');
        div.innerHTML = `<span style="color:#9ca3af">${time}</span> <b style="color:${color}">${p}</b> ${text}`;
        logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight;
      };
      const logTx = u8arr => logLine('>', u8arr, '#60a5fa');
      const logInfo = t => logLine('*', t, '#f59e0b');

      // App state
      const store = { devices: new Map(), tiles: new Map(), activeId: null, lastCfgReqId: null };

      // Tiles
      function makeTile(id, st) {
        const root = document.createElement('div');
        root.className = 'dev-item'; root.tabIndex = 0; root.dataset.id = String(id); root.setAttribute('role', 'button'); root.setAttribute('aria-selected', 'false');
        root.innerHTML = `
        <div class="mono idtxt">0x${id.toString(16).toUpperCase()}</div>
        <div class="dev-tags">
          <span class="tag unit">units: ${st.units === 1 ? 'deg' : 'rad'}</span>
          <span class="tag spd">spd: ${st.speed != null ? st.speed.toFixed(2) : '—'}</span>
          <span class="tag ang">ang: ${st.angle != null ? st.angle.toFixed(2) : '—'}</span>
          <span class="tag tmp">T: ${st.temp != null ? st.temp.toFixed(1) : '—'}</span>
          <span class="tag cal ${st.cal ? '' : 'warn'}">${st.cal ? 'CAL' : 'UNCAL'}</span>
        </div>
        <div class="mono ts" style="opacity:.7">${st.ts ? new Date(st.ts).toLocaleTimeString() : ''}</div>`;
        const focus = () => setActive(id);
        root.onclick = focus; root.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); focus(); } };
        devListEl.appendChild(root);
        const fields = {
          root,
          unit: root.querySelector('.unit'),
          spd: root.querySelector('.spd'),
          ang: root.querySelector('.ang'),
          tmp: root.querySelector('.tmp'),
          cal: root.querySelector('.cal'),
          ts: root.querySelector('.ts'),
          idtxt: root.querySelector('.idtxt')
        };
        store.tiles.set(id, fields);
        return fields;
      }

      function updateTile(id, st) {
        let t = store.tiles.get(id); if (!t) t = makeTile(id, st);
        const isImu = st.type === 'imu';

        if (isImu) {
          if (t.unit) t.unit.textContent = 'IMU';
          if (t.spd) t.spd.textContent = 'R: ' + (st.roll != null ? st.roll.toFixed(1) : '—');
          if (t.ang) t.ang.textContent = 'P: ' + (st.pitch != null ? st.pitch.toFixed(1) : '—');
          if (t.tmp) t.tmp.textContent = 'Y: ' + (st.yaw != null ? st.yaw.toFixed(1) : '—');
          const tempVal = (st.imuTemp != null ? st.imuTemp : st.temp);
          if (t.cal) {
            t.cal.textContent = 'T: ' + (tempVal != null ? tempVal.toFixed(1) : '—');
            t.cal.classList.remove('warn');
          }
        } else {
          if (t.unit) t.unit.textContent = 'units: ' + (st.units === 1 ? 'deg' : 'rad');
          if (t.spd) t.spd.textContent = 'spd: ' + (st.speed != null ? st.speed.toFixed(2) : '—');
          if (t.ang) t.ang.textContent = 'ang: ' + (st.angle != null ? st.angle.toFixed(2) : '—');
          if (t.tmp) t.tmp.textContent = 'T: ' + (st.temp != null ? st.temp.toFixed(1) : '—');
          if (t.cal) { t.cal.textContent = st.cal ? 'CAL' : 'UNCAL'; t.cal.classList.toggle('warn', !st.cal); }
          t.root.classList.toggle('stalled', !!st.stalled);
        }

        if (t.ts) t.ts.textContent = st.ts ? new Date(st.ts).toLocaleTimeString() : '';
        const act = store.activeId === id; t.root.classList.toggle('active', act); t.root.setAttribute('aria-selected', act ? 'true' : 'false');
      }

      function filterList() {
        const q = (devSearch.value || '').trim().toLowerCase();
        for (const [id, t] of store.tiles) {
          const st = store.devices.get(id) || {};
          const txt = ('' + id) + ' ' + (st.type || '') + ' ' + (st.cal ? 'calibrated' : 'not') + ' ' + (st.stalled ? 'stalled' : '');
          t.root.style.display = (!q || txt.toLowerCase().includes(q)) ? '' : 'none';
        }
      }

      function refreshListDevices() {
        const ids = [...store.devices.keys()].sort((a, b) => a - b);
        ids.forEach(id => {
          const st = store.devices.get(id) || {};
          if (!store.tiles.has(id)) makeTile(id, st); else updateTile(id, st);
        });
        filterList();
      }

      function setActive(id) {
        if (!store.devices.has(id)) return;
        store.activeId = id;
        for (const [tid, t] of store.tiles) {
          const act = tid === id;
          t.root.classList.toggle('active', act);
          t.root.setAttribute('aria-selected', act ? 'true' : 'false');
        }
        // Force full sync on selection so inputs populate
        syncFormFromState(id, true);
        renderActive(); gate(); preview();
      }

      function renderActive() {
        const st = store.devices.get(store.activeId);
        activeIdEl.textContent = (store.activeId == null) ? '—' : (`0x${store.activeId.toString(16).toUpperCase()} (${store.activeId})`);

        const isImu = (st && st.type === 'imu');

        // Toggle Controls visibility
        if (isImu) {
          motorControls.classList.add('hidden');
          imuControls.classList.remove('hidden');
          imuTag.classList.remove('hidden');
          motorUnitsTag.classList.add('hidden');
          // Hide motor specific params in setup
          document.querySelectorAll('.motor-specific').forEach(el => el.classList.add('hidden'));

          // IMU Stats
          const r = st.roll || 0, p = st.pitch || 0, y = st.yaw || 0;
          valRoll.textContent = r.toFixed(2);
          valPitch.textContent = p.toFixed(2);
          valYaw.textContent = y.toFixed(2);
          valAx.textContent = (st.ax || 0).toFixed(2);
          valAy.textContent = (st.ay || 0).toFixed(2);
          valAz.textContent = (st.az || 0).toFixed(2);

          // 3D Cube Transform
          imuCube.style.transform = `rotateX(${p}deg) rotateZ(${y * -1}deg) rotateY(${r}deg)`;

          // Telemetry sidebar
          tlmSpeed.textContent = '—';
          tlmAngle.textContent = '—';
          const tempVal = (st.imuTemp != null ? st.imuTemp : st.temp);
          tlmTemp.textContent = tempVal != null ? tempVal.toFixed(1) : '—';
          tlmMin.textContent = '—';
          tlmMax.textContent = '—';
          tlmCal.textContent = '—';
          tlmStalled.textContent = '—';
          tlmTune.textContent = '—';
          stallWarn.classList.add('hidden');
        } else {
          motorControls.classList.remove('hidden');
          imuControls.classList.add('hidden');
          imuTag.classList.add('hidden');
          motorUnitsTag.classList.remove('hidden');
          document.querySelectorAll('.motor-specific').forEach(el => el.classList.remove('hidden'));

          // Existing Motor Render Logic
          const units = st ? (st.units || 0) : 0;
          activeUnitsEl.textContent = units === 1 ? 'deg' : 'rad';
          targetUnitsEl.textContent = units === 1 ? 'deg' : 'rad';
          $('btn90').textContent = units === 1 ? '90°' : 'π/2';
          $('btn180').textContent = units === 1 ? '180°' : 'π';

          tlmSpeed.textContent = st && st.speed != null ? st.speed.toFixed(4) : '—';
          tlmAngle.textContent = st && st.angle != null ? st.angle.toFixed(4) : '—';
          tlmTemp.textContent = st && st.temp != null ? st.temp.toFixed(1) : '—';
          tlmMin.textContent = st && st.min != null ? (st.min ? 'YES' : 'NO') : '—';
          tlmMax.textContent = st && st.max != null ? (st.max ? 'YES' : 'NO') : '—';
          tlmCal.textContent = st && st.cal ? 'YES' : 'NO';

          // Stalled + Tuning
          const isStalled = !!(st && st.stalled);
          tlmStalled.textContent = isStalled ? 'YES' : 'NO';
          tlmStalled.style.color = isStalled ? '#ef4444' : 'inherit';
          stallWarn.classList.toggle('hidden', !isStalled);

          const tuneVal = (st && st.tuneState) || 0;
          const tuneStr = TUNE_STATES[tuneVal] || String(tuneVal);
          tlmTune.textContent = tuneStr;
          tlmTune.style.color = (tuneVal !== 0) ? '#60a5fa' : 'inherit';
        }
      }

      function renderTable() {
        const ids = [...store.devices.keys()].sort((a, b) => a - b);
        tblBodies.innerHTML = '';
        ids.forEach(id => {
          const s = store.devices.get(id) || {};
          const tr = document.createElement('tr');
          const td = v => { const el = document.createElement('td'); el.textContent = v; return el; };
          const tdHTML = h => { const el = document.createElement('td'); el.innerHTML = h; return el; };
          tr.appendChild(td(id));

          if (s.type === 'imu') {
            tr.appendChild(td('deg')); // Units
            tr.appendChild(td(`R: ${(s.roll || 0).toFixed(2)}`)); // Speed col reused
            tr.appendChild(td(`P: ${(s.pitch || 0).toFixed(2)}`)); // Angle col reused
            tr.appendChild(td(`Y: ${(s.yaw || 0).toFixed(2)}`));    // Temp col reused

            // Blank out motor columns for IMU
            tr.appendChild(td('—')); // Stalled
            tr.appendChild(td('—')); // Tune
            tr.appendChild(td('—')); // Min
            tr.appendChild(td('—')); // Max
            tr.appendChild(td('—')); // Cal
          } else {
            tr.appendChild(td(s.units === 1 ? 'deg' : 'rad'));
            tr.appendChild(td(s.speed != null ? s.speed.toFixed(3) : '—'));
            tr.appendChild(td(s.angle != null ? s.angle.toFixed(3) : '—'));
            tr.appendChild(td(s.temp != null ? s.temp.toFixed(1) : '—'));

            // Stalled
            if (s.stalled) tr.appendChild(tdHTML('<b style="color:#ef4444">YES</b>'));
            else tr.appendChild(td('NO'));

            // Tune
            const ts = s.tuneState || 0;
            if (ts !== 0) tr.appendChild(tdHTML(`<b style="color:#60a5fa">${TUNE_STATES[ts] || ts}</b>`));
            else tr.appendChild(td('Idle'));

            tr.appendChild(td(s.min != null ? (s.min ? 'YES' : 'NO') : '—'));
            tr.appendChild(td(s.max != null ? (s.max ? 'YES' : 'NO') : '—'));
            tr.appendChild(td(s.cal ? 'YES' : 'NO'));
          }

          tr.appendChild(td(s.ts ? new Date(s.ts).toLocaleTimeString() : '—'));
          tblBodies.appendChild(tr);
        });
      }

      function gate() {
        const gatedEls = document.querySelectorAll('.gated input, .gated select, .gated button, .gated textarea');
        const st = store.devices.get(store.activeId);
        if (!st) {
          gatedEls.forEach(el => { el.disabled = true; });
          calibWarn.classList.add('hidden');
          return;
        }
        if (st.type === 'imu') {
          // IMU: disable all motor controls, hide calib warning
          gatedEls.forEach(el => { el.disabled = true; });
          calibWarn.classList.add('hidden');
          return;
        }
        const ok = !!(st && st.cal);
        gatedEls.forEach(el => { el.disabled = !ok; });
        calibWarn.classList.toggle('hidden', !(store.activeId && !ok));
      }

      function preview() {
        if (store.activeId == null) { previewEl.textContent = '—'; return; }
        const id = store.activeId, val = parseFloat(inTarget.value) || 0;
        previewEl.textContent = bytesHex(frame.target(id, val));
      }

      const AXIS_CFG_SIZE = 36;
      function parseTelemetryPayload(canArbId, u8arr) {
        if (u8arr.length < AXIS_CFG_SIZE + 20) return null;
        const dv = new DataView(u8arr.buffer, u8arr.byteOffset, u8arr.byteLength);
        let o = 0;
        o += 4; // crc32
        const microsteps = dv.getUint16(o, true); o += 2;
        const stepsPerRev = dv.getUint16(o, true); o += 2;
        const units = dv.getUint8(o); o += 1;
        const flags = dv.getUint8(o); o += 1;
        o += 2; // encZero
        const currentmA = dv.getUint16(o, true); o += 2;
        const maxRPS = dv.getFloat32(o, true); o += 4;
        const maxRPS2 = dv.getFloat32(o, true); o += 4;
        const kp = dv.getFloat32(o, true); o += 4;
        const ki = dv.getFloat32(o, true); o += 4;
        const kd = dv.getFloat32(o, true); o += 4;
        const payloadCanId = dv.getUint16(o, true); o += 2;

        // Tail
        const speed = dv.getFloat32(o, true); o += 4;
        const angle = dv.getFloat32(o, true); o += 4;
        const target = dv.getFloat32(o, true); o += 4;
        const temp = dv.getFloat32(o, true); o += 4;
        const stalled = dv.getUint8(o) !== 0; o += 1;
        const tuneState = dv.getUint8(o); o += 1;
        const min = dv.getUint8(o) !== 0; o += 1;
        const max = dv.getUint8(o) !== 0; o += 1;

        const cal = (flags & 0x40) !== 0;
        return {
          id: payloadCanId, units, speed, angle, target, temp, stalled, tuneState, min, max, cal, flags,
          microsteps, stepsPerRev, currentmA, maxRPS, maxRPS2, kp, ki, kd
        };
      }

      // IMU telemetry parsing
      function parseImuTelemetry(canArbId, u8arr) {
        if (u8arr.length < 28) return null;
        const dv = new DataView(u8arr.buffer, u8arr.byteOffset, u8arr.byteLength);

        const roll = dv.getFloat32(0, true);
        const pitch = dv.getFloat32(4, true);
        const yaw = dv.getFloat32(8, true);
        const ax = dv.getFloat32(12, true);
        const ay = dv.getFloat32(16, true);
        const az = dv.getFloat32(20, true);
        const temp = dv.getFloat32(24, true);

        if (!isFinite(roll) || !isFinite(pitch) || !isFinite(yaw)) return null;

        // Return ID from header
        return { id: canArbId, roll, pitch, yaw, ax, ay, az, temp };
      }

      // Flags
      const FL = { ENCINV: 0x01, DIRINV: 0x02, STEALTH: 0x04, EXTMODE: 0x08, ENDSTOP: 0x10, EXTENC: 0x20, CAL: 0x40 };

      // UPDATED SYNC FUNCTION: Checks fullSync to determine if inputs should be overwritten
      function syncFormFromState(id, fullSync = false) {
        const st = store.devices.get(id);
        if (!st || st.type === 'imu') return;

        // Units - always keep in sync as this affects how we read the numbers
        const isDeg = (st.units === 1);
        const u = $('tglUnitsDeg');
        if (u) { u.indeterminate = false; u.checked = isDeg; }

        // --- FLAGS (Always sync these live, as they indicate active state) ---
        const fl = st.flags ?? 0;
        const setCB = (el, on) => {
          // Only update if user isn't currently clicking/holding it
          if (el && document.activeElement !== el) {
            el.indeterminate = false;
            el.checked = !!on;
          }
        };

        setCB($('tglStealth'), (fl & FL.STEALTH));
        setCB($('tglExtEnc'), (fl & FL.EXTENC));
        setCB($('tglExtMode'), (fl & FL.EXTMODE));
        setCB($('tglEndstop'), (fl & FL.ENDSTOP));
        setCB($('tglEncInvert'), (fl & FL.ENCINV));
        setCB($('tglDirInvert'), (fl & FL.DIRINV));

        // External SPI has no telemetry, so we don't overwrite it here.

        // --- INPUTS (Only sync these when explicitly requested, e.g. on selection) ---
        if (fullSync) {
          const setVal = (el, v) => {
            if (el && v != null) {
               // CRITICAL FIX: Even if code requests full sync, DO NOT overwrite the
               // specific input the user is currently typing in.
               if (document.activeElement === el) return;
               el.value = String(v);
            }
          };

          setVal($('ms'), st.microsteps);
          setVal($('spr'), st.stepsPerRev);
          setVal($('inmA'), st.currentmA);

          if (st.maxRPS != null) {
            const v = st.maxRPS.toFixed(2).replace(/\.0+$/, '').replace(/\.$/, '');
            setVal($('inRps'), v);
          }
          if (st.maxRPS2 != null) {
            const v = st.maxRPS2.toFixed(1).replace(/\.0+$/, '').replace(/\.$/, '');
            setVal($('inRps2'), v);
          }

          if (st.kp != null) {
            const v = st.kp.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');
            setVal($('pidKp'), v);
          }
          if (st.ki != null) {
            const v = st.ki.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');
            setVal($('pidKi'), v);
          }
          if (st.kd != null) {
            const v = st.kd.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');
            setVal($('pidKd'), v);
          }
        }

        // Update labels that depend on units (Always safe to update)
        $('activeUnits').textContent = isDeg ? 'deg' : 'rad';
        $('targetUnits').textContent = isDeg ? 'deg' : 'rad';
        $('btn90').textContent = isDeg ? '90°' : 'π/2';
        $('btn180').textContent = isDeg ? '180°' : 'π';
      }

      // Web Serial (single writer + queued writes)
      let port = null, reader = null, rxBuf = new Uint8Array(0);
      let writer = null, writeQueue = Promise.resolve();

      $('btnConnect').onclick = async () => {
        try {
          if (!('serial' in navigator)) { setStatus('Use Chrome/Edge.'); return; }
          if (port) {
            try {
              if (writer) {
                try { await writer.close?.() } catch { }
                try { writer.releaseLock() } catch { }
                writer = null;
              }
              reader?.releaseLock();
              await port.close();
            } catch { }
            port = null; setStatus('Disconnected'); $('btnConnect').textContent = 'Connect'; logInfo('Disconnected'); return;
          }
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 }); // fixed baud
          writer = port.writable.getWriter();
          setStatus('Connected'); $('btnConnect').textContent = 'Disconnect'; logInfo('Connected');
          devSearch.value = ''; filterList();
          reader = port.readable.getReader();
          (async () => {
            try {
              for (; ;) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value && value.length) appendBuf(value);
              }
            } catch { }
          })();
          navigator.serial.addEventListener('disconnect', e => { if (e.port === port) { $('btnConnect').click(); } });
        } catch (e) { setStatus('Connect failed: ' + (e?.message || e)); }
      };

      async function sendBytes(u8arr) {
        if (!port || !writer) return;
        writeQueue = writeQueue.then(async () => {
          try { await writer.write(u8arr); logTx(u8arr); }
          catch (e) {
            const msg = String(e?.message || e);
            if (msg.includes('WritableStream is locked')) return;
            setStatus('Write failed: ' + msg);
          }
        });
        return writeQueue;
      }

      function appendBuf(chunk) {
        const m = new Uint8Array(rxBuf.length + chunk.length);
        m.set(rxBuf, 0); m.set(chunk, rxBuf.length); rxBuf = m; processBuf();
      }

      function processBuf() {
        while (rxBuf.length >= 4) {
          const id = rxBuf[0] | (rxBuf[1] << 8), cmd = rxBuf[2], len = rxBuf[3], total = 4 + len;
          if (rxBuf.length < total) return;
          const payload = rxBuf.subarray(4, 4 + len);

          // DEBUG LOGGING
          console.log(`PKT ID:0x${id.toString(16)} CMD:0x${cmd.toString(16)} LEN:${len}`);

          // 1. Motor Telemetry (Command 0x01) - ID can be anything
          if (cmd === CMD.TELEMETRY) {
            const p = parseTelemetryPayload(id, payload); // Pass ID from header
            if (p) {
              const prev = store.devices.get(p.id) || {};
              const isNew = !store.devices.has(p.id);
              
              // Only trigger "Finished" if previous state was active (1-4) and now is 5.
              // This prevents flickering between Idle(0) and Done(5) from triggering syncs.
              const prevTune = prev.tuneState || 0;
              const tuneFinished = (p.tuneState === 5 && (prevTune >= 1 && prevTune <= 4));

              const st = {
                ...prev,
                type: 'motor',
                units: p.units,
                speed: p.speed,
                angle: p.angle,
                target: p.target,
                temp: p.temp,
                stalled: p.stalled,
                tuneState: p.tuneState,
                min: p.min,
                max: p.max,
                cal: p.cal,
                flags: p.flags,
                ts: Date.now(),
                microsteps: p.microsteps,
                stepsPerRev: p.stepsPerRev,
                currentmA: p.currentmA,
                maxRPS: p.maxRPS,
                maxRPS2: p.maxRPS2,
                kp: p.kp,
                ki: p.ki,
                kd: p.kd
              };

              store.devices.set(p.id, st);
              updateTile(p.id, st);

              if (store.activeId === p.id) {
                if (tuneFinished) {
                  logInfo(`Auto-Tune complete for ID ${p.id}. Syncing UI.`);
                  // Auto-tune changed internal values, so force a sync
                  syncFormFromState(p.id, true);
                }
                renderActive();
                if (!tuneFinished) {
                  // Normal update: do NOT overwrite inputs
                  syncFormFromState(p.id, false);
                }
              }

              if (store.activeId === null || isNew) {
                if (store.activeId === null) setActive(p.id);
                // New device -> Force sync inputs
                if (store.activeId === p.id) syncFormFromState(p.id, true);
              }
              renderActive(); renderTable(); gate();
            }
          }
          // 2. IMU Telemetry (Command 0x02)
          else if (cmd === CMD.IMU_TELEMETRY) {
            const imu = parseImuTelemetry(id, payload); // Pass ID from header
            if (imu) {
              const prev = store.devices.get(imu.id) || {};
              const st = {
                ...prev,
                type: 'imu',
                roll: imu.roll,
                pitch: imu.pitch,
                yaw: imu.yaw,
                ax: imu.ax,
                ay: imu.ay,
                az: imu.az,
                imuTemp: imu.temp,
                temp: imu.temp,
                ts: Date.now()
              };
              store.devices.set(imu.id, st);
              updateTile(imu.id, st);
              if (store.activeId === null) {
                setActive(imu.id);
              } else {
                renderActive();
              }
              renderTable(); gate();
            }
          } else {
            const hexId = id.toString(16).toUpperCase();
            const hexCmd = cmd.toString(16).toUpperCase();
          }

          rxBuf = rxBuf.subarray(total);
        }
      }

      // Buttons / inputs
      $('btnRefreshDevices').onclick = () => { refreshListDevices(); };
      $('btnRefreshList').onclick = () => { refreshListDevices(); };
      devSearch.addEventListener('input', filterList);

      inTarget.addEventListener('input', preview);
      $('btn0').onclick = () => { inTarget.value = '0'; preview(); };
      $('btn90').onclick = () => {
        const st = store.devices.get(store.activeId);
        const isDeg = st && st.units === 1;
        inTarget.value = isDeg ? '90' : (Math.PI / 2).toFixed(3); preview();
      };
      $('btn180').onclick = () => {
        const st = store.devices.get(store.activeId);
        const isDeg = st && st.units === 1;
        inTarget.value = isDeg ? '180' : (Math.PI).toFixed(3); preview();
      };

      $('btnSendTarget').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return; // ignore for IMU
        sendBytes(frame.target(store.activeId, parseFloat(inTarget.value) || 0));
      };
      $('btnSendLimits').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        const id = store.activeId;
        const rps = parseFloat(inRps.value) || 0;
        const rps2 = parseFloat(inRps2.value) || 0;
        sendBytes(frame.speed(id, rps)); sendBytes(frame.accel(id, rps2));
      };
      $('btnSetCurrent').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        sendBytes(frame.current(store.activeId, parseInt(inmA.value, 10) || 0));
      };
      $('btnCal').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        sendBytes(frame.calibrate(store.activeId));
      };
      $('btnAutoTune').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        const min = parseFloat(inTuneMin.value) || 0;
        const max = parseFloat(inTuneMax.value) || 0;
        sendBytes(frame.autoTune(store.activeId, min, max));
        setStatus('Auto-Tune started...');
      };

      // Zero IMU Button
      $('btnImuZero').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') {
          sendBytes(frame.resetOrient(store.activeId));
          logInfo(`Sent Zero Orientation to IMU ${store.activeId}`);
        }
      };

      tglEnable.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglEnable.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_ENABLED, tglEnable.checked));
      };

      // UPDATED ID BUTTON: Checks device type and passes flag to setId
      $('btnApplyID').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        const oldId = store.activeId;
        const nid = clamp11(parseInt(newIdEl.value, 10) || 0);
        if (nid === oldId) return;

        // Check if current device is IMU
        const isImu = (st && st.type === 'imu');
        
        sendBytes(frame.setId(oldId, nid, isImu));
        
        // Update Store
        const dev = store.devices.get(oldId) || {};
        store.devices.delete(oldId);
        store.devices.set(nid, dev);
        const tile = store.tiles.get(oldId);
        if (tile) {
          tile.root.dataset.id = String(nid);
          tile.idtxt.textContent = '0x' + nid.toString(16).toUpperCase();
          store.tiles.delete(oldId);
          store.tiles.set(nid, tile);
        }
        setActive(nid);
      };

      $('btnApplyStepper').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        const id = store.activeId;
        sendBytes(frame.microsteps(id, parseInt(msEl.value, 10) || 16));
        sendBytes(frame.stepsPerRev(id, parseInt(sprEl.value, 10) || 200));
      };

      tglUnitsDeg.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglUnitsDeg.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_UNITS, tglUnitsDeg.checked)); renderActive();
      };
      tglStealth.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglStealth.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_STEALTHCHOP, tglStealth.checked));
      };
      tglExtEnc.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglExtEnc.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_EXT_ENCODER, tglExtEnc.checked));
      };
      tglExtMode.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglExtMode.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_EXT_MODE, tglExtMode.checked));
      };
      tglEndstop.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglEndstop.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_ENDSTOP, tglEndstop.checked));
      };
      tglEncInvert.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglEncInvert.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_ENC_INVERT, tglEncInvert.checked));
      };
      tglDirInvert.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglDirInvert.checked = false; return; }
        sendBytes(frame.bool1(store.activeId, CMD.SET_DIR_INVERT, tglDirInvert.checked));
      };

      // NEW: External SPI (write-only; not in telemetry)
      tglExtSPI.onchange = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') { tglExtSPI.checked = false; return; }
        const id = store.activeId;
        const checked = tglExtSPI.checked;
        sendBytes(frame.bool1(id, CMD.SET_EXT_SPI, checked));
        const dev = store.devices.get(id) || {};
        dev.extSpi = checked;
        store.devices.set(id, dev);
      };

      $('btnApplyPID').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        const id = store.activeId;
        sendBytes(frame.pid(id, parseFloat(pidKp.value) || 0, parseFloat(pidKi.value) || 0, parseFloat(pidKd.value) || 0));
      };

      $('btnDoHome').onclick = () => {
        if (store.activeId == null) return;
        const st = store.devices.get(store.activeId);
        if (st && st.type === 'imu') return;
        const id = store.activeId;
        const params = {
          useMINTrigger: homeUseMin.checked,
          offset: parseFloat(homeOffset.value) || 0,
          activeLow: homeActiveLow.checked,
          speed: parseFloat(homeSpeed.value) || 0,
          direction: homeDirPlus.checked
        };
        sendBytes(frame.homing(id, params));
      };

      $('btnSequential').onclick = async () => {
        const ids = [...store.devices.keys()].sort((a, b) => a - b);
        const start = clamp11(parseInt($('bulkStart').value, 10) || 1);
        for (let i = 0; i < ids.length; i++) {
          const cur = ids[i], target = clamp11(start + i);
          const dev = store.devices.get(cur);
          if (!dev || dev.type === 'imu') continue;
          if (cur === target) continue;
          await sendBytes(frame.setId(cur, target));
          const st = store.devices.get(cur) || {};
          store.devices.delete(cur);
          store.devices.set(target, st);
          const tile = store.tiles.get(cur);
          if (tile) {
            tile.root.dataset.id = String(target);
            tile.idtxt.textContent = '0x' + target.toString(16).toUpperCase();
            store.tiles.delete(oldId);
            store.tiles.set(target, tile);
          }
        }
        refreshListDevices(); setStatus('Sequential IDs applied');
      };

      $('btnClear').onclick = () => { logEl.textContent = ''; };
      $('btnSave').onclick = () => {
        const lines = Array.from(logEl.children).map(el => el.textContent || '');
        const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = 'can_log.txt'; a.click(); URL.revokeObjectURL(url);
      };
      $('btnExport').onclick = () => {
        const rows = [['id', 'type', 'units', 'speed', 'angle_or_yaw', 'temp', 'min', 'max', 'stalled', 'cal', 'last_seen']];
        [...store.devices.keys()].sort((a, b) => a - b).forEach(id => {
          const s = store.devices.get(id) || {};
          const type = s.type || '';
          if (s.type === 'imu') {
            const tempVal = (s.imuTemp != null ? s.imuTemp : s.temp);
            rows.push([
              id,
              type,
              'deg',
              '',
              s.yaw ?? '',
              tempVal ?? '',
              '',
              '',
              '',
              '',
              s.ts ? new Date(s.ts).toISOString() : ''
            ]);
          } else {
            rows.push([
              id,
              type,
              s.units === 1 ? 'deg' : 'rad',
              s.speed ?? '',
              s.angle ?? '',
              s.temp ?? '',
              s.min ?? '',
              s.max ?? '',
              s.stalled ? 'YES' : 'NO',
              s.cal ? '1' : '0',
              s.ts ? new Date(s.ts).toISOString() : ''
            ]);
          }
        });
        const csv = rows.map(r => r.map(x => String(x)).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = 'devices.csv'; a.click(); URL.revokeObjectURL(url);
      };

      // Initial paint
      renderTable(); gate();
    })();
  </script>
</body>

</html>